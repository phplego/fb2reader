<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>FB2 –ß–∏—Ç–∞–ª–∫–∞ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º (OpenRouter)</title>
        <link
            rel="icon"
            type="image/svg+xml"
            sizes="any"
            href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjMDAwIi8+PGNpcmNsZSBjeD0iOCIgY3k9IjgiIHI9IjYiIGZpbGw9IiMwMGZmNDEiLz48L3N2Zz4="
        />
        <style>
            :root {
                --bg: #0b0f14;
                --panel: #121821;
                --muted: #6b7a90;
                --text: #e9eef7;
                --accent: #7bd88f;
                --accent-2: #5da9ff;
                --danger: #ff6b6b;
                --border: #1e2633;
                --chip: #0f141d;
                --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: linear-gradient(180deg, var(--bg), #0e141d);
                color: var(--text);
                font:
                    15px/1.6 system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Ubuntu,
                    Cantarell,
                    "Helvetica Neue",
                    Arial,
                    "Apple Color Emoji",
                    "Segoe UI Emoji";
            }
            header {
                position: sticky;
                top: 0;
                z-index: 3;
                backdrop-filter: saturate(1.2) blur(6px);
                background: rgba(10, 14, 20, 0.7);
                border-bottom: 1px solid var(--border);
            }
            .bar {
                display: flex;
                gap: 0.75rem;
                align-items: center;
                padding: 0.7rem 1rem;
                flex-wrap: wrap;
            }
            .title {
                font-weight: 700;
                letter-spacing: 0.2px;
                margin-right: 0.5rem;
            }
            .spacer {
                flex: 1;
            }
            .chip {
                background: var(--chip);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 0.45rem 0.65rem;
                border-radius: 10px;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }
            input[type="file"],
            select,
            input[type="text"] {
                color: var(--text);
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 0.5rem 0.6rem;
                outline: none;
                box-shadow: none;
            }
            input[type="text"]::placeholder {
                color: #8b97aa;
            }
            button {
                background: linear-gradient(180deg, #182235, #111827);
                color: var(--text);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 0.55rem 0.8rem;
                cursor: pointer;
                box-shadow: var(--shadow);
                transition: transform 0.03s ease;
            }
            button:hover {
                transform: translateY(-1px);
            }
            button.accent {
                background: linear-gradient(180deg, #0f2b1b, #0b2015);
                border-color: #163b27;
                color: #c6f7d0;
            }
            button.blue {
                background: linear-gradient(180deg, #0e2240, #0a1a31);
                border-color: #143058;
                color: #cae1ff;
            }
            button.danger {
                background: linear-gradient(180deg, #3a1212, #2a0e0e);
                border-color: #6b1f1f;
                color: #ffdada;
            }
            main {
                max-width: 980px;
                margin: 1rem auto 4rem;
                padding: 0 1rem;
            }
            .file-meta {
                color: var(--muted);
                margin: 0.35rem 0 1rem;
                display: flex;
                gap: 1rem;
                flex-wrap: wrap;
            }
            .para {
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 1rem 0.9rem;
                margin: 0.6rem 0;
                box-shadow: var(--shadow);
                position: relative;
            }
            .para[data-status="loading"] {
                opacity: 0.7;
            }
            .para-number {
                position: absolute;
                left: -0.6rem;
                top: -0.6rem;
                background: #101724;
                border: 1px solid var(--border);
                padding: 0.25rem 0.5rem;
                border-radius: 11px;
                font-size: 0.8rem;
                color: #a8b7cc;
            }
            .para .original {
                cursor: pointer;
            }
            .para .original:hover {
                background: rgba(123, 216, 143, 0.08);
                transition: background 0.2s;
            }
            .actions {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                margin-top: 0.6rem;
                flex-wrap: wrap;
                color: #9ab0c6;
                font-size: 0.9rem;
            }
            .actions .hint {
                opacity: 0.8;
            }
            .translation {
                margin-top: 0.75rem;
                padding: 0.75rem 0.75rem;
                border-left: 3px solid var(--accent);
                background: rgba(123, 216, 143, 0.08);
                border-radius: 10px;
            }
            .translation em {
                color: #d7ffe4;
            }
            .muted {
                color: var(--muted);
            }
            .badge {
                background: #0f1520;
                border: 1px solid var(--border);
                padding: 0.15rem 0.45rem;
                border-radius: 8px;
                font-size: 0.78rem;
            }
            .hidden {
                display: none !important;
            }
            .spinner {
                width: 14px;
                height: 14px;
                border: 2px solid #2a3648;
                border-top-color: var(--accent);
                border-radius: 50%;
                display: inline-block;
                animation: spin 0.8s linear infinite;
                vertical-align: -2px;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
            .divider {
                height: 1px;
                background: var(--border);
                margin: 1rem 0;
                opacity: 0.8;
            }
            .jump {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                flex-wrap: wrap;
            }
            .footer-info {
                color: #8294ab;
                font-size: 0.88rem;
                margin-top: 1.2rem;
            }
            /* Modal */
            .modal {
                position: fixed;
                inset: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.55);
                z-index: 10;
                padding: 1rem;
            }
            .modal > .card {
                width: min(620px, 100%);
                background: #0f1520;
                border: 1px solid var(--border);
                border-radius: 16px;
                box-shadow: var(--shadow);
                padding: 1rem;
                display: flex;
                flex-direction: column;
                gap: 0.6rem;
            }
            .card h3 {
                margin: 0.2rem 0 0.2rem;
                font-size: 1.15rem;
            }
            .card p {
                margin: 0.2rem 0;
                color: #9db0c7;
            }
            .row {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                align-items: center;
            }
            .grow {
                flex: 1;
            }
            code.k {
                background: #09111b;
                border: 1px solid #102033;
                padding: 0.15rem 0.35rem;
                border-radius: 8px;
            }
            .linklike {
                text-decoration: underline;
                cursor: pointer;
                color: #8ac8ff;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="bar">
                <div class="title">üìñ FB2 ‚Üí –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</div>

                <label class="chip">
                    <input id="fileInput" type="file" accept=".fb2,.xml" />
                    <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å FB2</span>
                </label>

                <label class="chip" title="–Ø–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∞">
                    <span>–Ø–∑—ã–∫:</span>
                    <select id="lang">
                        <option value="ru" selected>–†—É—Å—Å–∫–∏–π (ru)</option>
                        <option value="en">English (en)</option>
                        <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (uk)</option>
                        <option value="de">Deutsch (de)</option>
                        <option value="fr">Fran√ßais (fr)</option>
                        <option value="es">Espa√±ol (es)</option>
                        <option value="it">Italiano (it)</option>
                        <option value="pl">Polski (pl)</option>
                        <option value="tr">T√ºrk√ße (tr)</option>
                        <option value="zh">‰∏≠Êñá (zh)</option>
                        <option value="ja">Êó•Êú¨Ë™û (ja)</option>
                    </select>
                </label>

                <label class="chip" title="–ú–æ–¥–µ–ª—å –Ω–∞ OpenRouter">
                    <span>–ú–æ–¥–µ–ª—å:</span>
                    <input
                        id="model"
                        type="text"
                        value="qwen/qwen3-235b-a22b-2507"
                        size="18"
                    />
                </label>

                <button id="setKeyBtn" class="blue">üîë –ö–ª—é—á OpenRouter</button>
                <div class="spacer"></div>

                <div class="jump">
                    <input
                        id="gotoInput"
                        type="text"
                        placeholder="–ü–µ—Ä–µ–π—Ç–∏ –∫ # –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞‚Ä¶"
                        size="18"
                    />
                    <button id="gotoBtn">–ü–µ—Ä–µ–π—Ç–∏</button>
                    <button
                        id="toggleUntranslatedBtn"
                        title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–ø–µ—Ä–µ–≤–µ–¥—ë–Ω–Ω—ã–µ"
                    >
                        –§–∏–ª—å—Ç—Ä: –Ω–µ–ø–µ—Ä–µ–≤–µ–¥—ë–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>
        </header>

        <main>
            <div id="fileMeta" class="file-meta hidden"></div>
            <div id="output"></div>
            <div id="emptyState" class="footer-info">
                –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª .fb2 ‚Äî –≤—Å–µ –∞–±–∑–∞—Ü—ã –±—É–¥—É—Ç –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω—ã. –ö–ª–∏–∫ –ø–æ
                –∞–±–∑–∞—Ü—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ OpenRouter –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç
                —Ä–µ–∑—É–ª—å—Ç–∞—Ç <em>–ø–æ–¥</em> –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º.<br />
                –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–ø—Ä–æ—Å–∏—Ç API-–∫–ª—é—á –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –≤
                <code class="k">localStorage</code>. –ü–µ—Ä–µ–≤–æ–¥—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è
                –ª–æ–∫–∞–ª—å–Ω–æ (–ø–æ —Ñ–∞–π–ª—É/—è–∑—ã–∫—É/–ø–∞—Ä–∞–≥—Ä–∞—Ñ—É).
            </div>
        </main>

        <!-- –ú–æ–¥–∞–ª–∫–∞: –≤–≤–æ–¥ –∫–ª—é—á–∞ -->
        <div id="keyModal" class="modal hidden" role="dialog" aria-modal="true">
            <div class="card">
                <h3>üîë API-–∫–ª—é—á OpenRouter</h3>
                <p>
                    –°–æ–∑–¥–∞–π—Ç–µ –∫–ª—é—á –Ω–∞
                    <span
                        class="linklike"
                        onclick="window.open('https://openrouter.ai/keys','_blank')"
                        >openrouter.ai/keys</span
                    >
                    –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∑–¥–µ—Å—å. –ö–ª—é—á –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
                    –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
                </p>
                <div class="row">
                    <input
                        id="apiKeyInput"
                        type="text"
                        class="grow"
                        placeholder="sk-or-v1-..."
                    />
                    <button id="saveKeyBtn" class="accent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button id="closeKeyBtn">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <p class="muted">
                    –í–∞—à –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –í—ã –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
                    –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ö–ª—é—á OpenRouter¬ª.
                </p>
            </div>
        </div>

        <script>
            (() => {
                const els = {
                    file: document.getElementById("fileInput"),
                    lang: document.getElementById("lang"),
                    model: document.getElementById("model"),
                    out: document.getElementById("output"),
                    meta: document.getElementById("fileMeta"),
                    empty: document.getElementById("emptyState"),
                    setKeyBtn: document.getElementById("setKeyBtn"),
                    keyModal: document.getElementById("keyModal"),
                    apiKeyInput: document.getElementById("apiKeyInput"),
                    saveKeyBtn: document.getElementById("saveKeyBtn"),
                    closeKeyBtn: document.getElementById("closeKeyBtn"),
                    gotoInput: document.getElementById("gotoInput"),
                    gotoBtn: document.getElementById("gotoBtn"),
                    toggleUntranslatedBtn: document.getElementById(
                        "toggleUntranslatedBtn",
                    ),
                };

                let state = {
                    apiKey: null,
                    fileHash: null,
                    fileName: null,
                    totalParas: 0,
                    showOnlyUntranslated: false,
                };

                // ==== Local Storage helpers ====
                const LS_KEY = "openrouter_api_key";
                const LS_MODEL = "fb2_model";
                const getTransKey = (hash, lang, idx) =>
                    `t_${hash}_${lang}_${idx}`;
                const getLastPosKey = (hash) => `lastpos_${hash}`;

                function loadPersisted() {
                    const k = localStorage.getItem(LS_KEY);
                    if (k) state.apiKey = k;
                    const m = localStorage.getItem(LS_MODEL);
                    if (m) els.model.value = m;
                }

                function ensureApiKey(force = false) {
                    if (force || !state.apiKey) {
                        els.apiKeyInput.value = state.apiKey || "";
                        els.keyModal.classList.remove("hidden");
                        els.apiKeyInput.focus({ preventScroll: true });
                        return false;
                    }
                    return true;
                }

                function saveApiKey() {
                    const v = (els.apiKeyInput.value || "").trim();
                    if (!v) return;
                    state.apiKey = v;
                    localStorage.setItem(LS_KEY, v);
                    els.keyModal.classList.add("hidden");
                }

                function removeApiKey() {
                    state.apiKey = null;
                    localStorage.removeItem(LS_KEY);
                }

                // ==== FB2 parsing ====
                async function computeHash(arrayBuffer) {
                    const hash = await crypto.subtle.digest(
                        "SHA-256",
                        arrayBuffer,
                    );
                    // to hex
                    const bytes = new Uint8Array(hash);
                    return [...bytes]
                        .map((b) => b.toString(16).padStart(2, "0"))
                        .join("");
                }

                function fb2ToParagraphNodes(xmlDoc) {
                    // Collect <p> inside <body> (any depth). Skip poems' <v>? We keep them as p for simplicity.
                    const bodies = Array.from(
                        xmlDoc.getElementsByTagName("body"),
                    );
                    const paras = [];
                    bodies.forEach((body, bi) => {
                        // Insert a body divider if multiple bodies
                        const pNodes = body.querySelectorAll("section p, p");
                        pNodes.forEach((p) => paras.push(p));
                    });
                    return paras;
                }

                function fb2ExtractTitle(doc) {
                    // Try <book-title> from description, or first title paragraph
                    const bt = doc.getElementsByTagName("book-title")[0];
                    if (bt && bt.textContent) return bt.textContent.trim();
                    const titleP = doc.querySelector("title p");
                    return titleP ? titleP.textContent.trim() : "Untitled";
                }

                function sanitizeInline(node) {
                    // Recursively convert allowed FB2 inline tags to HTML string
                    const ALLOWED = {
                        emphasis: "em",
                        strong: "strong",
                        sub: "sub",
                        sup: "sup",
                        strikethrough: "s",
                        code: "code",
                        a: "a",
                        i: "i",
                        b: "b",
                    };
                    if (node.nodeType === Node.TEXT_NODE) {
                        return node.nodeValue
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;");
                    }
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const tag = node.tagName.toLowerCase();
                        if (tag in ALLOWED) {
                            const htmlTag = ALLOWED[tag];
                            let attrs = "";
                            if (htmlTag === "a") {
                                const href =
                                    node.getAttribute("href") ||
                                    node.getAttribute("l:href") ||
                                    "#";
                                attrs = ` href="${href.replace(/"/g, "&quot;")}" target="_blank" rel="noopener" `;
                            }
                            const inner = Array.from(node.childNodes)
                                .map(sanitizeInline)
                                .join("");
                            return `<${htmlTag}${attrs}>${inner}</${htmlTag}>`;
                        }
                        // Drop other tags but keep text
                        return Array.from(node.childNodes)
                            .map(sanitizeInline)
                            .join("");
                    }
                    return "";
                }

                function paragraphToHTML(pNode) {
                    // Titles sometimes appear as <p><strong>...</strong></p> ‚Äî we just render inline safely
                    return (
                        Array.from(pNode.childNodes)
                            .map(sanitizeInline)
                            .join("")
                            .trim() || pNode.textContent.trim()
                    );
                }

                // ==== Rendering ====
                function renderParagraphs(
                    paras,
                    fileHash,
                    fileName,
                    bookTitle,
                ) {
                    state.totalParas = paras.length;
                    els.out.innerHTML = "";
                    els.meta.classList.remove("hidden");
                    els.empty.classList.add("hidden");
                    const lastPos = parseInt(
                        localStorage.getItem(getLastPosKey(fileHash)) || "0",
                        10,
                    );

                    els.meta.innerHTML = `
      <span class="badge">File: ${escapeHtml(fileName)}</span>
      <span class="badge">Title: ${escapeHtml(bookTitle)}</span>
      <span class="badge">Paragraphs: ${paras.length}</span>
      ${lastPos ? `<span class="badge">Last #: ${lastPos}</span>` : ""}
    `;

                    paras.forEach((pNode, i) => {
                        const idx = i + 1;
                        const html = paragraphToHTML(pNode);
                        if (!html) return;
                        const wrap = document.createElement("section");
                        wrap.className = "para";
                        wrap.id = `p-${idx}`;
                        wrap.dataset.idx = String(idx);

                        const num = document.createElement("div");
                        num.className = "para-number";
                        num.textContent = `#${idx}`;

                        const original = document.createElement("div");
                        original.className = "original";
                        original.innerHTML = html;

                        const actions = document.createElement("div");
                        actions.className = "actions";
                        actions.innerHTML = `
        <span class="hint">–ö–ª–∏–∫ –ø–æ –∞–±–∑–∞—Ü—É ‚Üí –ø–µ—Ä–µ–≤–æ–¥ ‚Üì</span>
        <span class="muted">|</span>
        <span class="muted">–ö–µ—à–∏—Ä—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</span>
        <span class="muted">|</span>
        <a href="javascript:" class="force-translate muted">Translate</a>
      `;

                        const translation = document.createElement("div");
                        translation.className = "translation hidden";
                        translation.innerHTML = `<span class="muted">–ü–µ—Ä–µ–≤–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</span>`;

                        wrap.appendChild(num);
                        wrap.appendChild(original);
                        wrap.appendChild(actions);
                        wrap.appendChild(translation);
                        els.out.appendChild(wrap);

                        // preload cached translation if exists
                        const cached = localStorage.getItem(
                            getTransKey(fileHash, els.lang.value, idx),
                        );
                        if (cached) {
                            translation.innerHTML = `${escapeHtml(cached)}`;
                            translation.classList.remove("hidden");
                        }

                        // Click to translate/toggle
                        wrap.addEventListener(
                            "click",
                            async (ev) => {
                                if (ev.target.closest("a.force-translate")) {
                                    await onTranslateClick(wrap, html, idx);
                                    return;
                                }
                                if (
                                    ev.target.closest(".original") &&
                                    translation.classList.contains("hidden") // click on the original works only once
                                ) {
                                    await onTranslateClick(wrap, html, idx);
                                }
                            },
                            false,
                        );
                    });

                    // Autoscroll to last
                    if (lastPos && document.getElementById(`p-${lastPos}`)) {
                        document.getElementById(`p-${lastPos}`).scrollIntoView({
                            behavior: "smooth",
                            block: "start",
                        });
                    }
                }

                // ==== Translation ====
                async function onTranslateClick(wrap, originalHtml, idx) {
                    const lang = els.lang.value;
                    const modelRaw = els.model.value.trim();
                    if (!ensureApiKey(false)) return;

                    const transEl = wrap.querySelector(".translation");
                    const cached = localStorage.getItem(
                        getTransKey(state.fileHash, lang, idx),
                    );
                    // Toggle if already present
                    if (cached) {
                        transEl.classList.toggle("hidden");
                        // Save last position
                        localStorage.setItem(
                            getLastPosKey(state.fileHash),
                            String(idx),
                        );
                    }

                    // strip HTML to plain text for LLM
                    const tmp = document.createElement("div");
                    tmp.innerHTML = originalHtml;
                    const originalText = tmp.textContent.trim();

                    if (!originalText) return;
                    wrap.dataset.status = "loading";
                    transEl.classList.remove("hidden");
                    transEl.innerHTML = `<span class="spinner"></span> <span class="muted">–ü–µ—Ä–µ–≤–æ–∂—É —á–µ—Ä–µ–∑ OpenRouter‚Ä¶</span>`;

                    try {
                        const model = (
                            modelRaw || "qwen/qwen3-235b-a22b-2507"
                        ).replace(/\/+$/, ""); // –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–±–∏—Ä–∞–µ–º —Ö–≤–æ—Å—Ç–æ–≤—ã–µ '/'
                        localStorage.setItem(LS_MODEL, model);

                        const response = await fetch(
                            "https://openrouter.ai/api/v1/chat/completions",
                            {
                                method: "POST",
                                headers: {
                                    Authorization: `Bearer ${state.apiKey}`,
                                    "Content-Type": "application/json",
                                    "X-Title": "FB2 Paragraph Translator",
                                    // 'Referer' —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–º—ã –Ω–µ –º–æ–∂–µ–º –∑–∞–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é)
                                },
                                body: JSON.stringify({
                                    model,
                                    messages: [
                                        {
                                            role: "system",
                                            content: `You are a precise translation engine. Translate the user's paragraph into ${lang}.
- Preserve meaning, tone and simple inline emphasis when obvious.
- Do NOT add commentary. Return ONLY the translation text.`,
                                        },
                                        { role: "user", content: originalText },
                                    ],
                                    temperature: 0.7,
                                }),
                            },
                        );

                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(
                                `–û—à–∏–±–∫–∞ API (${response.status}): ${text.slice(0, 300)}`,
                            );
                        }
                        const data = await response.json();
                        const output =
                            data.choices?.[0]?.message?.content?.trim();
                        if (!output) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏");

                        // Cache and render
                        localStorage.setItem(
                            getTransKey(state.fileHash, lang, idx),
                            output,
                        );
                        transEl.innerHTML = `${escapeHtml(output)}`;
                        localStorage.setItem(
                            getLastPosKey(state.fileHash),
                            String(idx),
                        );

                        // Optional: hide if filtered
                        applyUntranslatedFilter();
                    } catch (err) {
                        transEl.innerHTML = `<span style="color:var(--danger)">‚ùó ${escapeHtml(err.message || String(err))}</span>`;
                    } finally {
                        delete wrap.dataset.status;
                    }
                }

                // ==== UI actions ====
                els.setKeyBtn.addEventListener("click", () => {
                    if (state.apiKey) {
                        // offer to update or remove
                        const wantRemove = confirm(
                            "–ö–ª—é—á —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –£–¥–∞–ª–∏—Ç—å –µ–≥–æ?",
                        );
                        if (wantRemove) {
                            removeApiKey();
                            alert(
                                "–ö–ª—é—á —É–¥–∞–ª—ë–Ω. –ù–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π.",
                            );
                        } else {
                            ensureApiKey(true);
                        }
                    } else {
                        ensureApiKey(true);
                    }
                });

                els.saveKeyBtn.addEventListener("click", () => {
                    saveApiKey();
                });
                els.closeKeyBtn.addEventListener("click", () => {
                    els.keyModal.classList.add("hidden");
                });

                // file load
                els.file.addEventListener("change", async (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    state.fileName = file.name;
                    const buf = await file.arrayBuffer();
                    state.fileHash = await computeHash(buf);

                    // parse XML
                    const text = new TextDecoder("utf-8").decode(buf);
                    let xml;
                    try {
                        xml = new DOMParser().parseFromString(text, "text/xml");
                        // if parsererror
                        if (xml.querySelector("parsererror")) {
                            throw new Error(
                                "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å XML. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —ç—Ç–æ FB2.",
                            );
                        }
                    } catch (err) {
                        alert(
                            "–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ FB2: " +
                                (err.message || String(err)),
                        );
                        return;
                    }

                    // extract book title
                    bookTitle = fb2ExtractTitle(xml);

                    const paras = fb2ToParagraphNodes(xml);
                    if (!paras.length) {
                        alert("–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤ <p>.");
                        return;
                    }
                    renderParagraphs(
                        paras,
                        state.fileHash,
                        state.fileName,
                        bookTitle,
                    );
                });

                // goto paragraph
                els.gotoBtn.addEventListener("click", () => gotoPara());
                els.gotoInput.addEventListener("keydown", (ev) => {
                    if (ev.key === "Enter") gotoPara();
                });

                function gotoPara() {
                    const v = parseInt(els.gotoInput.value.trim(), 10);
                    if (!v || v < 1 || v > state.totalParas) return;
                    const el = document.getElementById(`p-${v}`);
                    if (el) {
                        el.scrollIntoView({
                            behavior: "smooth",
                            block: "start",
                        });
                        el.classList.add("focus");
                        setTimeout(() => el.classList.remove("focus"), 900);
                    }
                }

                // show only untranslated
                els.toggleUntranslatedBtn.addEventListener("click", () => {
                    state.showOnlyUntranslated = !state.showOnlyUntranslated;
                    els.toggleUntranslatedBtn.textContent =
                        state.showOnlyUntranslated
                            ? "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ"
                            : "–§–∏–ª—å—Ç—Ä: –Ω–µ–ø–µ—Ä–µ–≤–µ–¥—ë–Ω–Ω—ã–µ";
                    applyUntranslatedFilter();
                });

                function applyUntranslatedFilter() {
                    if (!state.fileHash) return;
                    const lang = els.lang.value;
                    const blocks = Array.from(
                        document.querySelectorAll(".para"),
                    );
                    blocks.forEach((b) => {
                        if (!state.showOnlyUntranslated) {
                            b.classList.remove("hidden");
                            return;
                        }
                        const idx = b.dataset.idx;
                        const cached = localStorage.getItem(
                            getTransKey(state.fileHash, lang, idx),
                        );
                        if (cached) b.classList.add("hidden");
                        else b.classList.remove("hidden");
                    });
                }

                // helpers
                function escapeHtml(s) {
                    return String(s).replace(
                        /[&<>"']/g,
                        (m) =>
                            ({
                                "&": "&amp;",
                                "<": "&lt;",
                                ">": "&gt;",
                                '"': "&quot;",
                                "'": "&#39;",
                            })[m],
                    );
                }

                // init
                loadPersisted();
                // Prompt for key lazily on first translation; –Ω–æ –º–æ–∂–Ω–æ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ:
                setTimeout(() => {
                    if (!state.apiKey) ensureApiKey(false);
                }, 500);
            })();
        </script>
    </body>
</html>
